<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‹é£è¯„è®ºç³»ç»Ÿ | Qiufeng Comment</title>
    <link rel="stylesheet" href="style.css">
    <!-- Chart.js ç”¨äºå›¾è¡¨ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta name="description" content="åŸºäº giscus çš„è¯„è®ºç³»ç»Ÿ - çŠ¶æ€ç›‘æ§ç‰ˆ">
    <style>
        /* ä»ªè¡¨æ¿æ ·å¼ */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .status-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        
        .status-card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .status-indicator {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .status-up { background: #d4edda; color: #155724; }
        .status-down { background: #f8d7da; color: #721c24; }
        .status-checking { background: #fff3cd; color: #856404; }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            margin: 10px 0;
            background: linear-gradient(45deg, #FF8C42, #DC442E);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.95em;
        }
        
        .last-updated {
            font-size: 0.85em;
            color: #999;
            margin-top: 10px;
        }
        
        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            grid-column: 1 / -1;
            height: 300px;
            margin-top: 20px;
        }
        
        /* åˆ·æ–°æŒ‰é’® */
        .refresh-btn {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #0366d6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }
        
        .refresh-btn:hover {
            background: #0256c4;
        }
        
        .refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0366d6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* é”™è¯¯æç¤º */
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #dc3545;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .stat-number {
                font-size: 2em;
            }
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ‚ ç§‹é£è¯„è®ºç³»ç»Ÿ</h1>
            <p class="subtitle">Qiufeng Comment - çŠ¶æ€ç›‘æ§ä¸­å¿ƒ</p>
        </header>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel" style="margin: 20px 0; text-align: center;">
            <button class="refresh-btn" onclick="refreshAllStats()">
                <span id="refresh-icon">ğŸ”„</span> åˆ·æ–°æ‰€æœ‰æ•°æ®
            </button>
            <div id="last-update-time" class="last-updated" style="margin-top: 10px;">
                æœ€åæ›´æ–°: <span id="update-time">--:--:--</span>
            </div>
        </div>
        
        <!-- çŠ¶æ€ä»ªè¡¨æ¿ -->
        <div class="dashboard">
            <!-- GitHub çŠ¶æ€ -->
            <div class="status-card">
                <div class="card-header">
                    <div class="card-title">
                        <span>ğŸš€</span> GitHub æœåŠ¡çŠ¶æ€
                    </div>
                    <span id="github-status" class="status-indicator status-checking">æ£€æµ‹ä¸­...</span>
                </div>
                <div id="github-status-detail">
                    <div class="loader" style="margin: 0 auto;"></div>
                </div>
                <div class="last-updated">
                    çŠ¶æ€æº: <a href="https://www.githubstatus.com/" target="_blank">GitHub Status</a>
                </div>
            </div>
            
            <!-- è¯„è®ºæ€»æ•° -->
            <div class="status-card">
                <div class="card-header">
                    <div class="card-title">
                        <span>ğŸ’¬</span> è¯„è®ºæ€»æ•°
                    </div>
                </div>
                <div id="total-comments" class="stat-number">--</div>
                <div class="stat-label">ç´¯è®¡æ”¶åˆ°è¯„è®ºæ•°é‡</div>
                <div class="last-updated">ä»Šæ—¥æ–°å¢: <span id="today-comments">--</span> æ¡</div>
            </div>
            
            <!-- æ´»è·ƒåº¦ -->
            <div class="status-card">
                <div class="card-header">
                    <div class="card-title">
                        <span>ğŸ“ˆ</span> æ´»è·ƒåº¦
                    </div>
                </div>
                <div id="active-threads" class="stat-number">--</div>
                <div class="stat-label">æ´»è·ƒè®¨è®ºä¸²</div>
                <div class="last-updated">å¹³å‡å›å¤æ•°: <span id="avg-replies">--</span></div>
            </div>
        </div>
        
        <!-- è¯„è®ºè¶‹åŠ¿å›¾è¡¨ -->
        <div class="status-card">
            <div class="card-header">
                <div class="card-title">
                    <span>ğŸ“Š</span> è¯„è®ºè¶‹åŠ¿ (æœ€è¿‘30å¤©)
                </div>
            </div>
            <div class="chart-container">
                <canvas id="commentsChart"></canvas>
            </div>
            <div class="last-updated" style="text-align: center;">
                æ•°æ®æ¯24å°æ—¶æ›´æ–°ä¸€æ¬¡
            </div>
        </div>
        
        <footer class="footer">
            <p>åŸºäº <a href="https://github.com/giscus/giscus" target="_blank">Giscus</a> | 
                æ•°æ®å­˜å‚¨äº <a href="https://github.com/qiufengcute/Qiufeng-Comment/discussions" target="_blank">GitHub Discussions</a> |
                <a href="https://www.githubstatus.com/" target="_blank">GitHub çŠ¶æ€</a>
            </p>
        </footer>
    </div>
    
    <!-- Giscus è„šæœ¬ -->
    <script src="https://giscus.app/client.js"
        data-repo="qiufengcute/Qiufeng-Comment"
        data-repo-id="R_kgDOQkDu2Q"
        data-category="Announcements"
        data-category-id="DIC_kwDOQkDu2c4Czffj"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="zh-CN"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
    </script>
    
    <!-- çŠ¶æ€ç›‘æ§è„šæœ¬ -->
    <script>
        // é…ç½®
        const CONFIG = {
            GITHUB_API: 'https://api.github.com',
            REPO_OWNER: 'qiufengcute',
            REPO_NAME: 'Qiufeng-Comment',
            GITHUB_STATUS_API: 'https://www.githubstatus.com/api/v2/summary.json',
            UPDATE_INTERVAL: 300000, // 5åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡
            MAX_RETRIES: 3
        };
        
        // ç¼“å­˜
        let cache = {
            githubStatus: null,
            commentsData: null,
            lastUpdated: null
        };
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // é¦–æ¬¡åŠ è½½
            refreshAllStats();
            
            // å®šæ—¶æ›´æ–°
            setInterval(refreshAllStats, CONFIG.UPDATE_INTERVAL);
            
            // åˆå§‹åŒ–å›¾è¡¨
            initChart();
        });
        
        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshAllStats() {
            updateTime();
            
            const refreshBtn = document.querySelector('.refresh-btn');
            const icon = document.getElementById('refresh-icon');
            const originalIcon = icon.textContent;
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            refreshBtn.disabled = true;
            icon.textContent = 'â³';
            
            try {
                // å¹¶è¡Œè·å–æ‰€æœ‰æ•°æ®
                await Promise.all([
                    checkGitHubStatus(),
                    fetchCommentStats(),
                    updateChartData()
                ]);
                
                console.log('æ‰€æœ‰æ•°æ®æ›´æ–°å®Œæˆ');
            } catch (error) {
                console.error('æ•°æ®æ›´æ–°å¤±è´¥:', error);
                showError('æ•°æ®æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                refreshBtn.disabled = false;
                icon.textContent = originalIcon;
            }
        }
        
        // æ£€æŸ¥ GitHub çŠ¶æ€
        async function checkGitHubStatus(retryCount = 0) {
            const statusElement = document.getElementById('github-status');
            const detailElement = document.getElementById('github-status-detail');
            
            statusElement.className = 'status-indicator status-checking';
            statusElement.textContent = 'æ£€æµ‹ä¸­...';
            
            try {
                const response = await fetch(CONFIG.GITHUB_STATUS_API);
                if (!response.ok) throw new Error('GitHub Status API è¯·æ±‚å¤±è´¥');
                
                const data = await response.json();
                cache.githubStatus = data;
                
                // æ£€æŸ¥ä¸»è¦æœåŠ¡çŠ¶æ€
                const components = data.components;
                const incidents = data.incidents;
                
                // æ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒçš„æ•…éšœ
                const activeIncidents = incidents.filter(incident => incident.status !== 'resolved');
                
                if (activeIncidents.length > 0) {
                    // æœ‰æ•…éšœ
                    statusElement.className = 'status-indicator status-down';
                    statusElement.textContent = 'éƒ¨åˆ†æ•…éšœ';
                    
                    detailElement.innerHTML = `
                        <div class="error-message">
                            <strong>âš ï¸ å½“å‰æœ‰ ${activeIncidents.length} ä¸ªæ´»è·ƒæ•…éšœ:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                ${activeIncidents.slice(0, 3).map(incident => 
                                    `<li>${incident.name} (${incident.status})</li>`
                                ).join('')}
                            </ul>
                            ${activeIncidents.length > 3 ? '<p>... è¿˜æœ‰æ›´å¤šæ•…éšœ</p>' : ''}
                        </div>
                    `;
                } else {
                    // ä¸€åˆ‡æ­£å¸¸
                    statusElement.className = 'status-indicator status-up';
                    statusElement.textContent = 'è¿è¡Œæ­£å¸¸';
                    
                    // æ˜¾ç¤ºç»„ä»¶çŠ¶æ€
                    const criticalComponents = components.filter(comp => 
                        ['API', 'Git Operations', 'Issues', 'Discussions'].includes(comp.name)
                    );
                    
                    detailElement.innerHTML = `
                        <div style="color: #155724;">
                            <p><strong>âœ… æ‰€æœ‰ç³»ç»Ÿè¿è¡Œæ­£å¸¸</strong></p>
                            <p style="margin-top: 10px; font-size: 0.9em;">
                                å…³é”®æœåŠ¡çŠ¶æ€:
                                ${criticalComponents.map(comp => 
                                    `<span style="display: inline-block; margin-right: 10px; color: ${comp.status === 'operational' ? '#28a745' : '#dc3545'}">
                                        ${comp.name}: ${comp.status === 'operational' ? 'âœ“' : 'âœ—'}
                                    </span>`
                                ).join('')}
                            </p>
                        </div>
                    `;
                }
                
            } catch (error) {
                if (retryCount < CONFIG.MAX_RETRIES) {
                    console.log(`é‡è¯• GitHub çŠ¶æ€æ£€æµ‹ (${retryCount + 1}/${CONFIG.MAX_RETRIES})`);
                    setTimeout(() => checkGitHubStatus(retryCount + 1), 2000);
                    return;
                }
                
                statusElement.className = 'status-indicator status-down';
                statusElement.textContent = 'æ£€æµ‹å¤±è´¥';
                detailElement.innerHTML = `
                    <div class="error-message">
                        <p>æ— æ³•è·å– GitHub çŠ¶æ€ä¿¡æ¯</p>
                        <p style="font-size: 0.9em;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        // è·å–è¯„è®ºç»Ÿè®¡
        async function fetchCommentStats(retryCount = 0) {
            try {
                const response = await fetch(
                    `${CONFIG.GITHUB_API}/repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/discussions`,
                    {
                        headers: {
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (!response.ok) {
                    if (response.status === 403 && retryCount < CONFIG.MAX_RETRIES) {
                        // API é™åˆ¶ï¼Œç­‰å¾…åé‡è¯•
                        console.log('API é™åˆ¶ï¼Œç­‰å¾…é‡è¯•...');
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        return fetchCommentStats(retryCount + 1);
                    }
                    throw new Error(`GitHub API é”™è¯¯: ${response.status}`);
                }
                
                const discussions = await response.json();
                cache.commentsData = discussions;
                
                // è®¡ç®—ç»Ÿè®¡
                const totalComments = discussions.length;
                
                // è®¡ç®—ä»Šæ—¥æ–°å¢
                const today = new Date().toISOString().split('T')[0];
                const todayComments = discussions.filter(disc => {
                    const createdDate = new Date(disc.created_at).toISOString().split('T')[0];
                    return createdDate === today;
                }).length;
                
                // è®¡ç®—æ´»è·ƒè®¨è®ºå’Œå¹³å‡å›å¤æ•°
                const activeDiscussions = discussions.filter(disc => {
                    const updatedDate = new Date(disc.updated_at);
                    const daysSinceUpdate = (new Date() - updatedDate) / (1000 * 60 * 60 * 24);
                    return daysSinceUpdate < 7; // ä¸€å‘¨å†…æ›´æ–°è¿‡çš„ç®—æ´»è·ƒ
                });
                
                const totalReplies = discussions.reduce((sum, disc) => sum + disc.comments, 0);
                const avgReplies = totalComments > 0 ? (totalReplies / totalComments).toFixed(1) : 0;
                
                // æ›´æ–°UI
                document.getElementById('total-comments').textContent = totalComments;
                document.getElementById('today-comments').textContent = todayComments;
                document.getElementById('active-threads').textContent = activeDiscussions.length;
                document.getElementById('avg-replies').textContent = avgReplies;
                
            } catch (error) {
                if (retryCount < CONFIG.MAX_RETRIES) {
                    console.log(`é‡è¯•è¯„è®ºç»Ÿè®¡ (${retryCount + 1}/${CONFIG.MAX_RETRIES})`);
                    setTimeout(() => fetchCommentStats(retryCount + 1), 2000);
                    return;
                }
                
                console.error('è·å–è¯„è®ºç»Ÿè®¡å¤±è´¥:', error);
                document.getElementById('total-comments').textContent = 'é”™è¯¯';
                document.getElementById('today-comments').textContent = '--';
                document.getElementById('active-threads').textContent = '--';
                document.getElementById('avg-replies').textContent = '--';
                
                showError('æ— æ³•è·å–è¯„è®ºç»Ÿè®¡ä¿¡æ¯');
            }
        }
        
        // å›¾è¡¨ç›¸å…³
        let commentsChart = null;
        
        function initChart() {
            const ctx = document.getElementById('commentsChart').getContext('2d');
            
            commentsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æ¯æ—¥è¯„è®ºæ•°',
                        data: [],
                        borderColor: '#FF8C42',
                        backgroundColor: 'rgba(255, 140, 66, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            },
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    }
                }
            });
        }
        
        async function updateChartData() {
            try {
                // è·å–æœ€è¿‘30å¤©çš„è¯„è®ºæ•°æ®
                const discussions = cache.commentsData || [];
                
                // æŒ‰æ—¥æœŸåˆ†ç»„
                const last30Days = [];
                const now = new Date();
                
                // ç”Ÿæˆæœ€è¿‘30å¤©çš„æ—¥æœŸæ ‡ç­¾
                for (let i = 29; i >= 0; i--) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    last30Days.push(dateStr);
                }
                
                // ç»Ÿè®¡æ¯å¤©çš„è¯„è®ºæ•°
                const dailyComments = {};
                last30Days.forEach(date => {
                    dailyComments[date] = 0;
                });
                
                discussions.forEach(discussion => {
                    const createdDate = new Date(discussion.created_at).toISOString().split('T')[0];
                    if (dailyComments.hasOwnProperty(createdDate)) {
                        dailyComments[createdDate]++;
                    }
                });
                
                // å‡†å¤‡å›¾è¡¨æ•°æ®
                const labels = last30Days.map(date => {
                    const d = new Date(date);
                    return `${(d.getMonth() + 1)}/${d.getDate()}`;
                });
                
                const data = last30Days.map(date => dailyComments[date]);
                
                // æ›´æ–°å›¾è¡¨
                if (commentsChart) {
                    commentsChart.data.labels = labels;
                    commentsChart.data.datasets[0].data = data;
                    commentsChart.update();
                }
                
            } catch (error) {
                console.error('æ›´æ–°å›¾è¡¨æ•°æ®å¤±è´¥:', error);
            }
        }
        
        // è¾…åŠ©å‡½æ•°
        function updateTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { 
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            document.getElementById('update-time').textContent = timeStr;
            cache.lastUpdated = now;
        }
        
        function showError(message) {
            // å¯ä»¥æ·»åŠ å…¨å±€é”™è¯¯æç¤º
            console.error('ç³»ç»Ÿé”™è¯¯:', message);
        }
        
        // é¡µé¢å¯è§æ€§æ£€æµ‹ - å½“é¡µé¢é‡æ–°å¯è§æ—¶åˆ·æ–°æ•°æ®
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                refreshAllStats();
            }
        });
    </script>
</body>
</html>
