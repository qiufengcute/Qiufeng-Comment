<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <meta http-equiv="Permissions-Policy" content="public-client-requests=*, private-network-access=*">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‹é£è¯„è®ºç³»ç»Ÿ | Qiufeng Comment</title>
    <link rel="stylesheet" href="style.css">
    <!-- Chart.js ç”¨äºå›¾è¡¨ -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta name="description" content="åŸºäº giscus çš„è¯„è®ºç³»ç»Ÿ - çŠ¶æ€ç›‘æ§ç‰ˆ">
    <style>
        /* ä»ªè¡¨æ¿æ ·å¼ */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .status-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }
        
        .status-card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .status-indicator {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 500;
        }
        
        .status-up { background: #d4edda; color: #155724; }
        .status-down { background: #f8d7da; color: #721c24; }
        .status-checking { background: #fff3cd; color: #856404; }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            margin: 10px 0;
            background: linear-gradient(45deg, #FF8C42, #DC442E);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.95em;
        }
        
        .last-updated {
            font-size: 0.85em;
            color: #999;
            margin-top: 10px;
        }
        
        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            grid-column: 1 / -1;
            height: 300px;
            margin-top: 20px;
        }
        
        /* åˆ·æ–°æŒ‰é’® */
        .refresh-btn {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: #0366d6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }
        
        .refresh-btn:hover {
            background: #0256c4;
        }
        
        .refresh-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        /* åŠ è½½åŠ¨ç”» */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #0366d6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* é”™è¯¯æç¤º */
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #dc3545;
        }
        
        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .stat-number {
                font-size: 2em;
            }
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>ğŸ‚ ç§‹é£è¯„è®ºç³»ç»Ÿ</h1>
            <p class="subtitle">Qiufeng Comment - çŠ¶æ€ç›‘æ§ä¸­å¿ƒ</p>
        </header>
        
        <!-- æ§åˆ¶é¢æ¿ -->
        <div class="control-panel">
            <button class="refresh-btn" onclick="refreshAllStats()">
                <span id="refresh-icon">ğŸ”„</span> åˆ·æ–°æ‰€æœ‰æ•°æ®
            </button>
            <div id="last-update-time" class="last-updated">
                æœ€åæ›´æ–°: <span id="update-time">--:--:--</span>
            </div>
        </div>
        
        <!-- çŠ¶æ€ä»ªè¡¨æ¿ -->
        <div class="dashboard">
            <!-- GitHub çŠ¶æ€ -->
            <div class="status-card">
                <div class="card-header">
                    <div class="card-title">
                        <span>ğŸš€</span> GitHub æœåŠ¡çŠ¶æ€
                    </div>
                    <span id="github-status" class="status-indicator status-checking">æ£€æµ‹ä¸­...</span>
                </div>
                <div id="github-status-detail">
                    <div class="loader" style="margin: 0 auto;"></div>
                </div>
                <div class="last-updated">
                    çŠ¶æ€æº: <a href="https://www.githubstatus.com/" target="_blank">GitHub Status</a>
                </div>
            </div>
            
            <!-- è¯„è®ºæ€»æ•° -->
            <div class="status-card">
                <div class="card-header">
                    <div class="card-title">
                        <span>ğŸ’¬</span> è¯„è®ºæ€»æ•°
                    </div>
                </div>
                <div id="total-comments" class="stat-number">--</div>
                <div class="stat-label">ç´¯è®¡æ”¶åˆ°è¯„è®ºæ•°é‡</div>
                <div class="last-updated">ä»Šæ—¥æ–°å¢: <span id="today-comments">--</span> æ¡</div>
            </div>
            
            <!-- æ´»è·ƒåº¦ -->
            <div class="status-card">
                <div class="card-header">
                    <div class="card-title">
                        <span>ğŸ“ˆ</span> æ´»è·ƒåº¦
                    </div>
                </div>
                <div id="active-threads" class="stat-number">--</div>
                <div class="stat-label">æ´»è·ƒè®¨è®ºä¸²</div>
                <div class="last-updated">å¹³å‡å›å¤æ•°: <span id="avg-replies">--</span></div>
            </div>
        </div>
        
        <!-- è¯„è®ºè¶‹åŠ¿å›¾è¡¨ -->
        <div class="status-card">
            <div class="card-header">
                <div class="card-title">
                    <span>ğŸ“Š</span> è¯„è®ºè¶‹åŠ¿ (æœ€è¿‘30å¤©)
                </div>
            </div>
            <div class="chart-container">
                <canvas id="commentsChart"></canvas>
            </div>
        </div>
        
        <!-- Giscus è¯„è®ºå®¹å™¨ -->
        <div id="giscus-container" style="margin-top: 40px;"></div>
        
        <footer class="footer">
            <p>åŸºäº <a href="https://github.com/giscus/giscus" target="_blank">Giscus</a> | 
                æ•°æ®å­˜å‚¨äº <a href="https://github.com/qiufengcute/Qiufeng-Comment/discussions" target="_blank">GitHub Discussions</a> |
                <a href="https://www.githubstatus.com/" target="_blank">GitHub çŠ¶æ€</a>
            </p>
        </footer>
    </div>
    
    <!-- æ ¸å¿ƒè§£å†³æ–¹æ¡ˆï¼šå‰ç«¯ CORS ä»£ç†å‡½æ•° + åŠ¨æ€åŠ è½½ Giscus -->
    <script>
        // 1. æ ¸å¿ƒï¼šä¸€ä¸ªå‰ç«¯ CORS ä»£ç†å‡½æ•°
        async function fetchViaProxy(url, options = {}) {
            // å¤‡é€‰çš„å…¬å…± CORS ä»£ç†åˆ—è¡¨ï¼ˆå¦‚æœç¬¬ä¸€ä¸ªå¤±è´¥ï¼Œä¼šè‡ªåŠ¨å°è¯•ä¸‹ä¸€ä¸ªï¼‰
            const proxyServers = [
                'https://api.allorigins.win/raw?url=',  // ç¨³å®šä»£ç†1
                'https://corsproxy.io/?',                 // ç¨³å®šä»£ç†2
                'https://thingproxy.freeboard.io/fetch/'  // ç¨³å®šä»£ç†3
            ];
            
            let lastError = null;
            
            for (const proxy of proxyServers) {
                try {
                    const proxyUrl = proxy + encodeURIComponent(url);
                    console.log(`å°è¯•é€šè¿‡ä»£ç†è®¿é—®: ${proxyUrl}`);
                    
                    const response = await fetch(proxyUrl, {
                        ...options,
                        // é‡è¦ï¼šå¯¹ä»£ç†æœåŠ¡å™¨çš„è¯·æ±‚ä¸èƒ½ä½¿ç”¨ no-cors
                        mode: 'cors',
                        headers: {
                            ...options.headers,
                            'Accept': 'application/json',
                        }
                    });
                    
                    if (response.ok) {
                        console.log(`ä»£ç† ${proxy} æˆåŠŸ`);
                        return response;
                    }
                    throw new Error(`ä»£ç†å“åº”çŠ¶æ€: ${response.status}`);
                } catch (error) {
                    lastError = error;
                    console.warn(`ä»£ç† ${proxy} å¤±è´¥:`, error.message);
                    continue; // å°è¯•ä¸‹ä¸€ä¸ªä»£ç†
                }
            }
            
            throw new Error(`æ‰€æœ‰ä»£ç†æœåŠ¡å™¨å‡å¤±è´¥: ${lastError.message}`);
        }
        
        // 2. é‡å†™å…¨å±€ fetch å‡½æ•°ï¼ˆå¯é€‰ï¼Œç”¨äºæ‹¦æˆªæ‰€æœ‰å‡ºç«™è¯·æ±‚ï¼‰
        const originalFetch = window.fetch;
        window.fetch = async function(url, options = {}) {
            // åªå¯¹ GitHub API å’Œ Giscus ç›¸å…³è¯·æ±‚ä½¿ç”¨ä»£ç†
            const isGitHubRequest = url.includes('api.github.com') || 
                                   url.includes('github.com') || 
                                   url.includes('giscus.app');
            
            if (isGitHubRequest && url.startsWith('http')) {
                console.log(`æ‹¦æˆª GitHub è¯·æ±‚å¹¶ä½¿ç”¨ä»£ç†: ${url}`);
                try {
                    return await fetchViaProxy(url, options);
                } catch (error) {
                    console.error('ä»£ç†è¯·æ±‚å¤±è´¥ï¼Œå›é€€åˆ°åŸå§‹ fetch:', error);
                    // å¦‚æœæ‰€æœ‰ä»£ç†éƒ½å¤±è´¥ï¼Œå›é€€åˆ°åŸå§‹ fetchï¼ˆå¯èƒ½ä¼šå›  CORS å¤±è´¥ï¼‰
                    return originalFetch(url, { ...options, mode: 'no-cors' });
                }
            }
            
            // é GitHub è¯·æ±‚ï¼Œæ­£å¸¸å¤„ç†
            return originalFetch(url, options);
        };
        
        // 3. åŠ¨æ€åŠ è½½ Giscusï¼ˆç¡®ä¿åœ¨é‡å†™ fetch åæ‰§è¡Œï¼‰
        function loadGiscus() {
            const container = document.getElementById('giscus-container');
            if (!container) return;
            
            // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§å®ä¾‹
            container.innerHTML = '';
            
            const script = document.createElement('script');
            script.src = 'https://giscus.app/client.js';
            
            // Giscus é…ç½®ï¼ˆä½¿ç”¨æ‚¨çš„å®é™…é…ç½®ï¼‰
            const giscusConfig = {
                repo: 'qiufengcute/Qiufeng-Comment',
                repoId: 'R_kgDOQkDu2Q',
                category: 'Announcements',
                categoryId: 'DIC_kwDOQkDu2c4Czffj',
                mapping: 'pathname',
                strict: '0',
                reactionsEnabled: '1',
                emitMetadata: '0',
                inputPosition: 'top',
                theme: 'preferred_color_scheme',
                lang: 'zh-CN',
                loading: 'lazy'
            };
            
            // åº”ç”¨é…ç½®
            Object.keys(giscusConfig).forEach(key => {
                script.setAttribute(`data-${key}`, giscusConfig[key]);
            });
            
            script.crossOrigin = 'anonymous';
            script.async = true;
            
            // é‡è¦ï¼šæ·»åŠ é”™è¯¯å¤„ç†
            script.onerror = function() {
                console.error('Giscus è„šæœ¬åŠ è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ...');
                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ å¤‡ç”¨è¯„è®ºç³»ç»Ÿ
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 10px;">
                        <p>è¯„è®ºç³»ç»Ÿæš‚æ—¶æ— æ³•åŠ è½½</p>
                        <p><a href="https://github.com/qiufengcute/Qiufeng-Comment/discussions" target="_blank">ç›´æ¥å‰å¾€ GitHub Discussions å‚ä¸è®¨è®º</a></p>
                    </div>
                `;
            };
            
            container.appendChild(script);
        }
        
        // 4. é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // å…ˆåŠ è½½ Giscus
            loadGiscus();
            
            // åˆå§‹åŒ–å…¶ä»–åŠŸèƒ½ï¼ˆä½ çš„ç»Ÿè®¡å›¾è¡¨ç­‰ï¼‰
            setTimeout(() => {
                if (typeof refreshAllStats === 'function') {
                    refreshAllStats();
                }
                if (typeof initChart === 'function') {
                    initChart();
                }
            }, 1000);
        });
    </script>
    
    <!-- çŠ¶æ€ç›‘æ§è„šæœ¬ï¼ˆå·²é›†æˆä»£ç†åŠŸèƒ½ï¼‰ -->
    <script>
        // é…ç½®
        const CONFIG = {
            REPO_OWNER: 'qiufengcute',
            REPO_NAME: 'Qiufeng-Comment',
            GITHUB_STATUS_API: 'https://www.githubstatus.com/api/v2/summary.json',
            UPDATE_INTERVAL: 300000,
            MAX_RETRIES: 3
        };
        
        // ç¼“å­˜
        let cache = {
            githubStatus: null,
            commentsData: null,
            lastUpdated: null
        };
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // é¦–æ¬¡åŠ è½½ï¼ˆç°åœ¨é€šè¿‡ä»£ç†çš„ fetch ä¼šè‡ªåŠ¨å¤„ç†ï¼‰
            setTimeout(refreshAllStats, 500);
            setInterval(refreshAllStats, CONFIG.UPDATE_INTERVAL);
            setTimeout(initChart, 1000);
        });
        
        // åˆ·æ–°æ‰€æœ‰æ•°æ®
        async function refreshAllStats() {
            updateTime();
            
            const refreshBtn = document.querySelector('.refresh-btn');
            const icon = document.getElementById('refresh-icon');
            if (!refreshBtn || !icon) return;
            
            const originalIcon = icon.textContent;
            refreshBtn.disabled = true;
            icon.textContent = 'â³';
            
            try {
                await Promise.all([
                    checkGitHubStatus(),
                    fetchCommentStats(),
                    updateChartData()
                ]);
                console.log('æ‰€æœ‰æ•°æ®æ›´æ–°å®Œæˆ');
            } catch (error) {
                console.error('æ•°æ®æ›´æ–°å¤±è´¥:', error);
                showError('æ•°æ®æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            } finally {
                refreshBtn.disabled = false;
                icon.textContent = originalIcon;
            }
        }
        
        // æ£€æŸ¥ GitHub çŠ¶æ€
        async function checkGitHubStatus(retryCount = 0) {
            const statusElement = document.getElementById('github-status');
            const detailElement = document.getElementById('github-status-detail');
            if (!statusElement || !detailElement) return;
            
            statusElement.className = 'status-indicator status-checking';
            statusElement.textContent = 'æ£€æµ‹ä¸­...';
            
            try {
                // æ³¨æ„ï¼šè¿™é‡Œä¼šä½¿ç”¨æˆ‘ä»¬é‡å†™çš„ fetchï¼Œè‡ªåŠ¨èµ°ä»£ç†
                const response = await fetch(CONFIG.GITHUB_STATUS_API);
                if (!response.ok) throw new Error('çŠ¶æ€ API è¯·æ±‚å¤±è´¥');
                
                const data = await response.json();
                cache.githubStatus = data;
                
                const activeIncidents = data.incidents.filter(i => i.status !== 'resolved');
                
                if (activeIncidents.length > 0) {
                    statusElement.className = 'status-indicator status-down';
                    statusElement.textContent = 'éƒ¨åˆ†æ•…éšœ';
                    detailElement.innerHTML = `
                        <div class="error-message">
                            <strong>âš ï¸ å½“å‰æœ‰ ${activeIncidents.length} ä¸ªæ´»è·ƒæ•…éšœ:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                ${activeIncidents.slice(0, 3).map(incident => 
                                    `<li>${incident.name} (${incident.status})</li>`
                                ).join('')}
                            </ul>
                        </div>
                    `;
                } else {
                    statusElement.className = 'status-indicator status-up';
                    statusElement.textContent = 'è¿è¡Œæ­£å¸¸';
                    detailElement.innerHTML = `
                        <div style="color: #155724;">
                            <p><strong>âœ… æ‰€æœ‰ç³»ç»Ÿè¿è¡Œæ­£å¸¸</strong></p>
                        </div>
                    `;
                }
            } catch (error) {
                if (retryCount < CONFIG.MAX_RETRIES) {
                    setTimeout(() => checkGitHubStatus(retryCount + 1), 2000);
                    return;
                }
                statusElement.className = 'status-indicator status-down';
                statusElement.textContent = 'æ£€æµ‹å¤±è´¥';
                detailElement.innerHTML = `
                    <div class="error-message">
                        <p>æ— æ³•è·å–çŠ¶æ€ä¿¡æ¯</p>
                    </div>
                `;
            }
        }
        
        // è·å–è¯„è®ºç»Ÿè®¡
        async function fetchCommentStats(retryCount = 0) {
            try {
                // GitHub API è¯·æ±‚ä¼šè‡ªåŠ¨é€šè¿‡ä»£ç†
                const apiUrl = `https://api.github.com/repos/${CONFIG.REPO_OWNER}/${CONFIG.REPO_NAME}/discussions`;
                const response = await fetch(apiUrl, {
                    headers: { 'Accept': 'application/vnd.github.v3+json' }
                });
                
                if (!response.ok) {
                    if (response.status === 403 && retryCount < CONFIG.MAX_RETRIES) {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        return fetchCommentStats(retryCount + 1);
                    }
                    throw new Error(`API é”™è¯¯: ${response.status}`);
                }
                
                const discussions = await response.json();
                cache.commentsData = discussions;
                
                // æ›´æ–° UI
                const totalEl = document.getElementById('total-comments');
                const todayEl = document.getElementById('today-comments');
                const activeEl = document.getElementById('active-threads');
                const avgEl = document.getElementById('avg-replies');
                
                if (totalEl) totalEl.textContent = discussions.length;
                
                if (todayEl) {
                    const today = new Date().toISOString().split('T')[0];
                    const todayComments = discussions.filter(disc => 
                        new Date(disc.created_at).toISOString().split('T')[0] === today
                    ).length;
                    todayEl.textContent = todayComments;
                }
                
                if (activeEl) {
                    const activeDiscussions = discussions.filter(disc => {
                        const days = (new Date() - new Date(disc.updated_at)) / (1000 * 60 * 60 * 24);
                        return days < 7;
                    });
                    activeEl.textContent = activeDiscussions.length;
                }
                
                if (avgEl) {
                    const totalReplies = discussions.reduce((sum, disc) => sum + disc.comments, 0);
                    const avg = discussions.length > 0 ? (totalReplies / discussions.length).toFixed(1) : 0;
                    avgEl.textContent = avg;
                }
                
            } catch (error) {
                console.error('è·å–è¯„è®ºç»Ÿè®¡å¤±è´¥:', error);
                // è®¾ç½®é”™è¯¯çŠ¶æ€
                ['total-comments', 'today-comments', 'active-threads', 'avg-replies'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.textContent = 'é”™è¯¯';
                });
            }
        }
        
        // å›¾è¡¨ç›¸å…³å‡½æ•°ä¿æŒä¸å˜
        let commentsChart = null;
        function initChart() {
            const canvas = document.getElementById('commentsChart');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            commentsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'æ¯æ—¥è¯„è®ºæ•°',
                        data: [],
                        borderColor: '#FF8C42',
                        backgroundColor: 'rgba(255, 140, 66, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { stepSize: 1 } },
                        x: { grid: { color: 'rgba(0,0,0,0.05)' } }
                    }
                }
            });
        }
        
        async function updateChartData() {
            if (!commentsChart) return;
            try {
                const discussions = cache.commentsData || [];
                const last30Days = [];
                const now = new Date();
                
                for (let i = 29; i >= 0; i--) {
                    const date = new Date(now);
                    date.setDate(date.getDate() - i);
                    last30Days.push(date.toISOString().split('T')[0]);
                }
                
                const dailyComments = {};
                last30Days.forEach(date => dailyComments[date] = 0);
                discussions.forEach(disc => {
                    const date = new Date(disc.created_at).toISOString().split('T')[0];
                    if (dailyComments[date] !== undefined) dailyComments[date]++;
                });
                
                const labels = last30Days.map(date => {
                    const d = new Date(date);
                    return `${d.getMonth()+1}/${d.getDate()}`;
                });
                
                const data = last30Days.map(date => dailyComments[date]);
                commentsChart.data.labels = labels;
                commentsChart.data.datasets[0].data = data;
                commentsChart.update();
            } catch (error) {
                console.error('æ›´æ–°å›¾è¡¨å¤±è´¥:', error);
            }
        }
        
        function updateTime() {
            const timeEl = document.getElementById('update-time');
            if (!timeEl) return;
            const now = new Date();
            const timeStr = now.toLocaleTimeString('zh-CN', { 
                hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
            });
            timeEl.textContent = timeStr;
        }
        
        function showError(message) {
            console.error('ç³»ç»Ÿé”™è¯¯:', message);
        }
    </script>
</body>
</html>
